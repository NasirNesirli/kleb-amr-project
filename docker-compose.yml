# Docker Compose for AMR K. pneumoniae Prediction Pipeline
# Provides easy development and testing environment

version: '3.8'

services:
  # Main pipeline service
  amr-pipeline:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: amr-pipeline:latest
    container_name: amr-prediction-pipeline
    
    # Mount directories for data persistence
    volumes:
      # Data directories (read-only for input data)
      - ./data:/pipeline/data:ro
      - ./config:/pipeline/config:ro
      
      # Results directory (read-write for outputs)
      - ./results:/pipeline/results:rw
      - ./logs:/pipeline/logs:rw
      
      # Optional: Mount custom config for different runs
      # - ./config/custom.yaml:/pipeline/config/config.yaml:ro
    
    # Environment variables
    environment:
      - SNAKEMAKE_CORES=4
      - SNAKEMAKE_MEMORY=8G
      - PYTHONUNBUFFERED=1
      - CONDA_ENVS_PATH=/opt/conda/envs
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    
    # Default command - can be overridden
    command: ["--dry-run", "--cores", "4"]
    
    # Keep container running for interactive use
    tty: true
    stdin_open: true
    
    # Restart policy
    restart: unless-stopped

  # Development service with source code mounted
  amr-pipeline-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: pipeline-setup
    image: amr-pipeline:dev
    container_name: amr-prediction-dev
    
    volumes:
      # Mount source code for development
      - .:/pipeline:rw
      - ./data:/pipeline/data:ro
      - ./results:/pipeline/results:rw
      - ./logs:/pipeline/logs:rw
      
      # Cache conda environments
      - conda-cache:/opt/conda/pkgs
      - snakemake-cache:/pipeline/.snakemake
    
    environment:
      - SNAKEMAKE_CORES=4
      - SNAKEMAKE_MEMORY=8G
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/pipeline
    
    # Override user for development (allows file editing)
    user: root
    
    command: ["--help"]
    tty: true
    stdin_open: true

  # Quick test service for validation
  amr-test:
    extends: amr-pipeline
    container_name: amr-prediction-test
    command: ["--dry-run", "--quiet"]
    restart: "no"

# Named volumes for caching
volumes:
  conda-cache:
    driver: local
  snakemake-cache:
    driver: local

# Networks (optional, for multi-service setups)
networks:
  default:
    name: amr-pipeline-network